# NARA Library Agent - Integration Guide

## Overview

The NARA Library Background Agent integrates seamlessly with the existing NARA library system by:
- Writing directly to the PostgreSQL `bibliographic_records` table
- Using the same Firebase Storage bucket
- Generating QR codes compatible with the admin panel
- Following the same data schema and conventions

## Database Integration

### Schema Additions

The agent adds 6 new columns to the `bibliographic_records` table:

| Column | Type | Purpose |
|--------|------|---------|
| `url` | TEXT | Firebase Storage URL for PDF file |
| `download_source` | VARCHAR(100) | Source API (CORE, Internet Archive, etc.) |
| `source_url` | TEXT | Original URL where book was discovered |
| `file_hash` | VARCHAR(64) | SHA-256 hash for file integrity |
| `page_count` | INTEGER | Number of pages in PDF |
| `qr_code_url` | TEXT | Firebase Storage URL for QR code image |

### Migration

Run the migration to add these columns:

```bash
cd backend/library-api
psql -U postgres -d nara_library -f migrations/003_add_agent_fields.sql
```

### Data Flow

```
Agent → PostgreSQL bibliographic_records table → Frontend Catalogue
```

Books added by the agent are immediately visible in:
1. Library catalogue (`/library`)
2. Search results
3. Category filters
4. Admin panel

## Firebase Storage Integration

### Storage Structure

```
nara-web-73384.appspot.com/
├── pdfs/
│   ├── Acts/
│   ├── FAO Reports/
│   ├── Research Papers/
│   └── ... (26 categories)
└── qr-codes/
    ├── NARA1729048123456.png
    └── ...
```

### File Naming

**PDFs**: `pdfs/{category}/{barcode}-{sanitized-title}.pdf`
- Example: `pdfs/FAO Reports/NARA1729048123456-fisheries-management.pdf`

**QR Codes**: `qr-codes/{barcode}.png`
- Example: `qr-codes/NARA1729048123456.png`

### Access URLs

The agent generates signed URLs (7-day expiration) for both PDFs and QR codes. These are stored in the database and automatically refreshed when needed.

## QR Code Integration

### Generation

The agent uses the same QR code generation logic as the Enhanced Cataloguing Manager:

```javascript
const QRCode = require('qrcode');

const qrBuffer = await QRCode.toBuffer(barcode, {
  width: 200,
  margin: 2,
  color: {
    dark: '#000000',
    light: '#FFFFFF'
  }
});
```

### Storage

QR codes are uploaded to Firebase Storage and the URL is saved in `bibliographic_records.qr_code_url`.

### Admin Panel

QR codes generated by the agent are fully compatible with the admin panel:
- Visible in Enhanced Cataloguing Manager
- Printable with "Print QR Label" button
- Same format as manually generated codes

## Frontend Integration

### Library Catalogue

Downloaded books appear in the catalogue with:
- Full bibliographic details
- PDF download link (from `url` field)
- QR code (from `qr_code_url` field)
- Category filtering
- Full-text search

### Item Detail Page

The item detail page displays:
- Book metadata
- "Access Digital Copy" button (if `url` exists)
- Download source badge
- QR code (if available)

### Search

Books are indexed in PostgreSQL's full-text search:
- Title, author, publisher searchable
- Keywords and subject headings included
- Source URL available for reference

## API Endpoints

The existing library API automatically serves agent-downloaded books:

### Get All Books

```
GET /api/catalogue
```

Returns all books including agent-downloaded ones.

### Get Book by ID

```
GET /api/catalogue/:id
```

Returns full details including `url`, `download_source`, `qr_code_url`.

### Search Books

```
GET /api/search?q=marine
```

Searches all books including agent-downloaded ones.

### Filter by Category

```
GET /api/catalogue?material_type=FAO Reports
```

Returns books for specific category.

## Material Type Mapping

The agent maps categories to material types using the `material_types` table:

| Category | Code | Material Type ID |
|----------|------|------------------|
| Acts | ACT | 1 |
| FAO Reports | FAO | 7 |
| IOC Reports | IOC | 8 |
| Research Papers | RPAPER | 18 |
| ... | ... | ... |

The agent looks up the material type ID before inserting records.

## Barcode Generation

### Format

`NARA{timestamp}{random}`

Example: `NARA1729048123456`

- `NARA`: Prefix
- `17290481`: Last 8 digits of timestamp
- `234`: 3-digit random number

### Uniqueness

The agent checks the database for duplicates and regenerates if needed (rare).

## Data Sources

### CORE API

- **URL**: https://api.core.ac.uk/v3/search/works
- **Content**: Academic papers, research reports
- **Best for**: Research Papers, Thesis, e-Journal Articles

### Internet Archive

- **URL**: https://archive.org/advancedsearch.php
- **Content**: Books, reports, documents
- **Best for**: All categories

### DOAJ

- **URL**: https://doaj.org/api/v4/search/articles
- **Content**: Open access journal articles
- **Best for**: Journal, e-Journal Articles

### Open Library

- **URL**: https://openlibrary.org/search.json
- **Content**: Book metadata with Internet Archive links
- **Best for**: Electronic Books, Reference Books

## Error Handling

### Duplicate Detection

Before downloading, the agent checks if a book with the same title and author already exists:

```sql
SELECT barcode FROM bibliographic_records 
WHERE LOWER(title) = LOWER($1) AND LOWER(author) = LOWER($2)
```

If found, the job is skipped.

### Failed Downloads

Failed jobs are retried up to 3 times with exponential backoff. After max retries, the job is marked as failed and logged.

### Invalid PDFs

PDFs are validated for:
- Magic bytes (%PDF-)
- File size (max 50MB)
- Parseable metadata

Invalid files are rejected and logged.

## Monitoring

### Database Queries

**Count agent-downloaded books:**
```sql
SELECT COUNT(*) FROM bibliographic_records 
WHERE download_source IS NOT NULL;
```

**Books by source:**
```sql
SELECT download_source, COUNT(*) 
FROM bibliographic_records 
WHERE download_source IS NOT NULL 
GROUP BY download_source;
```

**Books by category:**
```sql
SELECT mt.name, COUNT(br.id) 
FROM material_types mt
LEFT JOIN bibliographic_records br ON mt.id = br.material_type_id
WHERE br.download_source IS NOT NULL
GROUP BY mt.name
ORDER BY COUNT(br.id) DESC;
```

### Firebase Storage

Check Firebase Console → Storage:
- `pdfs/` folder for downloaded PDFs
- `qr-codes/` folder for QR code images

### Queue Status

Check Redis for job queue status:
```bash
redis-cli
LLEN bull:bookDownloads:wait    # Waiting jobs
LLEN bull:bookDownloads:active  # Active jobs
LLEN bull:bookDownloads:completed # Completed jobs
LLEN bull:bookDownloads:failed  # Failed jobs
```

## Maintenance

### Re-running Failed Jobs

Failed jobs remain in the queue for 7 days. To retry:

```bash
# View failed jobs in Redis
redis-cli
LRANGE bull:bookDownloads:failed 0 -1

# Or clear and re-populate
npm run populate
```

### Updating Existing Books

To update agent-downloaded books:

```sql
UPDATE bibliographic_records 
SET status = 'available', 
    notes = 'Updated by agent'
WHERE download_source = 'CORE';
```

### Regenerating QR Codes

QR codes can be regenerated by the admin panel or by re-running the agent with updated books.

## Troubleshooting

### Books Not Appearing in Catalogue

1. Check database:
   ```sql
   SELECT * FROM bibliographic_records 
   WHERE barcode = 'NARA1729048123456';
   ```

2. Verify material type ID is valid:
   ```sql
   SELECT * FROM material_types WHERE id = 18;
   ```

3. Check status field is 'available'

### QR Codes Not Loading

1. Check `qr_code_url` field is populated
2. Verify Firebase Storage permissions
3. Check signed URL hasn't expired (7 days)

### PDFs Not Downloading

1. Check `url` field is populated
2. Verify Firebase Storage permissions
3. Check signed URL hasn't expired
4. Test URL in browser

## Best Practices

1. **Run populate script during off-hours** to avoid API rate limits
2. **Monitor worker logs** for errors and failed downloads
3. **Check database regularly** for duplicate entries
4. **Backup Firebase Storage** before bulk operations
5. **Test with small batch first** (1 book per category)

## Future Enhancements

Potential improvements:
- ISBN lookup API integration
- Automatic metadata enrichment
- Duplicate detection by ISBN
- Cover image downloads
- Author name normalization
- Subject heading classification
- Scheduled automatic runs
- Email notifications for completions

## Support

For integration issues:
- Check logs: `backend/library-agent/logs/`
- Review database: `psql -U postgres -d nara_library`
- Contact: marine-library@nara.gov.lk

